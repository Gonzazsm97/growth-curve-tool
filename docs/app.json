[{"name":"app.R","content":"library(shiny)\nlibrary(dplyr)      # Instead of tidyverse\nlibrary(readr)      # Instead of tidyverse\nlibrary(munsell)\nlibrary(ggplot2)    # Instead of tidyverse\nlibrary(stringr)    # Instead of tidyverse\nlibrary(tidyr)      # Instead of tidyverse\nlibrary(broom)\nlibrary(scales)\nlibrary(rstatix)\nlibrary(ggbeeswarm)\nlibrary(ggpubr)\nlibrary(DT)\nlibrary(svglite)\n\nui <- fluidPage(\n  titlePanel(\"Interactive Growth Curve & Doubling Time Analyzer\"),\n  \n  sidebarLayout(\n    sidebarPanel(\n      # --- Data Input ---\n      h4(\"1. Data Upload\"),\n      fileInput(\"file1\", \"Upload CSV File\",\n                accept = c(\"text/csv\", \"text/comma-separated-values,text/plain\", \".csv\")),\n      \n      h4(\"2. Column Mapping\"),\n      selectInput(\"col_day\", \"Day/Time Column:\", choices = NULL),\n      selectInput(\"col_density\", \"Density Column:\", choices = NULL),\n      selectInput(\"col_rep\", \"Replicate Column:\", choices = NULL),\n      \n      h5(\"Experimental Factors:\"),\n      selectInput(\"col_factor1\", \"Sample Type 1 (Main X-Axis):\", choices = NULL),\n      selectInput(\"col_factor2\", \"Sample Type 2 (Group/Fill):\", choices = c(\"None\")),\n      selectInput(\"col_factor3\", \"Sample Type 3 (Facet/Panel):\", choices = c(\"None\")),\n      \n      hr(),\n      \n      # --- Graph Controls ---\n      h4(\"3. Growth Curve Settings\"),\n      selectInput(\"gc_fill\", \"Color/Fill By:\", choices = c(\"Sample Type 1\")),\n      selectInput(\"gc_linetype\", \"Line Type By:\", choices = c(\"None\")),\n      selectInput(\"gc_facet\", \"Facet By:\", choices = c(\"None\")),\n      \n      checkboxInput(\"log_scale\", \"Log10 Scale Y-Axis\", value = TRUE),\n      \n      h4(\"4. Doubling Time Settings\"),\n      numericInput(\"start_day\", \"Start Calculation Day:\", value = 1, min = 0),\n      \n      hr(),\n      \n      # --- Export Controls ---\n      h4(\"5. Exports\"),\n      h5(\"Growth Curve:\"),\n      downloadButton(\"dl_gc_png\", \"PNG (300dpi)\"),\n      downloadButton(\"dl_gc_svg\", \"SVG\"),\n      br(), br(),\n      h5(\"Doubling Time Plot:\"),\n      downloadButton(\"dl_dt_png\", \"PNG (300dpi)\"),\n      downloadButton(\"dl_dt_svg\", \"SVG\")\n    ),\n    \n    mainPanel(\n      tabsetPanel(\n        tabPanel(\"Data Preview\", DTOutput(\"raw_table\")),\n        tabPanel(\"Growth Curve\", plotOutput(\"plot_gc\", height = \"700px\")),\n        tabPanel(\"Doubling Time Plot\", plotOutput(\"plot_dt\", height = \"700px\")),\n        tabPanel(\"Summary Statistics\", DTOutput(\"dt_table\"))\n      )\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n  \n  # --- 1. Data Processing ---\n  raw_data <- reactive({\n    req(input$file1)\n    read_csv(input$file1$datapath)\n  })\n  \n  # Update Dropdowns\n  observeEvent(raw_data(), {\n    cols <- names(raw_data())\n    updateSelectInput(session, \"col_day\", choices = cols, selected = cols[grep(\"Day|Time\", cols, ignore.case=T)][1])\n    updateSelectInput(session, \"col_density\", choices = cols, selected = cols[grep(\"Density|Count|Value\", cols, ignore.case=T)][1])\n    updateSelectInput(session, \"col_rep\", choices = cols, selected = cols[grep(\"Rep\", cols, ignore.case=T)][1])\n    updateSelectInput(session, \"col_factor1\", choices = cols)\n    updateSelectInput(session, \"col_factor2\", choices = c(\"None\", cols))\n    updateSelectInput(session, \"col_factor3\", choices = c(\"None\", cols))\n  })\n  \n  # Update Graph Control Options\n  observe({\n    req(input$col_factor1)\n    factors <- list(\"Sample Type 1\" = \"Type1\")\n    if(input$col_factor2 != \"None\") factors[[\"Sample Type 2\"]] <- \"Type2\"\n    if(input$col_factor3 != \"None\") factors[[\"Sample Type 3\"]] <- \"Type3\"\n    \n    facet_opts <- c(\"None\", factors)\n    if(input$col_factor2 != \"None\") facet_opts[[paste(\"Type 1 + Type 2\")]] <- \"Type1+Type2\"\n    if(input$col_factor3 != \"None\") {\n      facet_opts[[paste(\"Type 1 + Type 3\")]] <- \"Type1+Type3\"\n      if(input$col_factor2 != \"None\") facet_opts[[paste(\"Type 2 + Type 3\")]] <- \"Type2+Type3\"\n    }\n    \n    updateSelectInput(session, \"gc_fill\", choices = factors, selected = \"Type1\")\n    updateSelectInput(session, \"gc_linetype\", choices = c(\"None\", factors), selected = if(input$col_factor2!=\"None\") \"Type2\" else \"None\")\n    updateSelectInput(session, \"gc_facet\", choices = facet_opts, selected = \"None\")\n  })\n  \n  processed_data <- reactive({\n    req(raw_data(), input$col_day, input$col_density, input$col_rep, input$col_factor1)\n    df <- raw_data() %>%\n      rename(Day = !!sym(input$col_day), Density = !!sym(input$col_density), Replicate = !!sym(input$col_rep), Type1 = !!sym(input$col_factor1)) %>%\n      mutate(Type1 = as.factor(Type1))\n    \n    if (input$col_factor2 != \"None\") {\n      df <- df %>% rename(Type2 = !!sym(input$col_factor2)) %>% mutate(Type2 = as.factor(Type2))\n    } else { df$Type2 <- NA }\n    \n    if (input$col_factor3 != \"None\") {\n      df <- df %>% rename(Type3 = !!sym(input$col_factor3)) %>% mutate(Type3 = as.factor(Type3))\n    } else { df$Type3 <- NA }\n    return(df)\n  })\n  \n  dt_data <- reactive({\n    req(processed_data())\n    df <- processed_data()\n    grp_vars <- c(\"Type1\", \"Replicate\")\n    if(input$col_factor2 != \"None\") grp_vars <- c(grp_vars, \"Type2\")\n    if(input$col_factor3 != \"None\") grp_vars <- c(grp_vars, \"Type3\")\n    \n    df %>%\n      filter(Day >= input$start_day) %>%\n      group_by(across(all_of(grp_vars))) %>%\n      do({\n        mod <- tryCatch(lm(log(Density) ~ Day, data = .), error = function(e) NULL)\n        if(!is.null(mod)) tidy(mod) else tibble(term = \"Day\", estimate = NA)\n      }) %>%\n      ungroup() %>%\n      filter(term == \"Day\") %>%\n      mutate(doubling_time_hours = (log(2) / estimate) * 24) %>%\n      filter(!is.na(doubling_time_hours) & doubling_time_hours > 0)\n  })\n  \n  # --- 2. Plot Generators ---\n  gc_plot_obj <- reactive({\n    req(processed_data())\n    df <- processed_data()\n    fill_var <- input$gc_fill\n    \n    p <- ggplot(df, aes(x = Day, y = Density)) +\n      aes(fill = .data[[fill_var]], color = .data[[fill_var]])\n    \n    if(input$gc_linetype != \"None\") p <- p + aes(linetype = .data[[input$gc_linetype]])\n    \n    p <- p +\n      stat_summary(fun = mean, geom = \"line\") +\n      geom_point(size = 2, alpha = 0.6) +\n      stat_summary(fun = mean, geom = \"point\", shape = 21, size = 3, color = \"black\") +\n      stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = \"errorbar\", width = 0.05, alpha = 1) +\n      labs(title = \"Growth Curve\", x = \"Day\", y = \"Density (cells/mL)\") +\n      guides(color = \"none\") +\n      theme_classic(base_size = 16) +\n      theme(aspect.ratio = 1, axis.line = element_line(linewidth = 0.8), strip.background = element_rect(fill=\"grey90\"))\n    \n    if(input$log_scale) p <- p + \n      scale_y_log10(breaks = 10^(1:10), labels = trans_format(\"log10\", math_format(10^.x))) + \n      annotation_logticks(sides = \"l\", \n                          short = unit(-0.1, \"cm\"),\n                          mid = unit(-0.175, \"cm\"),\n                          long = unit(-0.25, \"cm\"))\n    \n    if(input$gc_facet != \"None\"){\n      if(grepl(\"\\\\+\", input$gc_facet)){\n        vars <- strsplit(input$gc_facet, \"\\\\+\")[[1]]\n        p <- p + facet_wrap(vars, axes = \"all\")\n      } else {\n        p <- p + facet_wrap(input$gc_facet, axes = \"all\")\n      }\n    }\n    return(p)\n  })\n  \n  dt_plot_obj <- reactive({\n    req(dt_data())\n    df_dt <- dt_data()\n    p <- ggplot(df_dt, aes(x = Type1, y = doubling_time_hours))\n    \n    if(input$col_factor3 != \"None\" && input$col_factor2 != \"None\"){\n      p <- p + aes(fill = Type2) +\n        stat_summary(fun = mean, geom = \"bar\", position = position_dodge(width = 0.8), width = 0.7, color = \"black\") +\n        stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = \"errorbar\", position = position_dodge(width = 0.8), width = 0.3, alpha = 1) +\n        geom_beeswarm(aes(group = Type2), dodge.width = 0.8, shape = 21, size = 2.5, colour = \"black\", cex = 2) +\n        facet_wrap(~Type3, axes = \"all\") + labs(fill = input$col_factor2) +\n        geom_pwc(aes(group = Type2), method = \"t_test\", label = \"p.signif\", hide.ns = \"p\")\n    } else if(input$col_factor2 != \"None\") {\n      p <- p + aes(fill = Type2) +\n        stat_summary(fun = mean, geom = \"bar\", position = position_dodge(width = 0.8), width = 0.7, color = \"black\") +\n        stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = \"errorbar\", position = position_dodge(width = 0.8), width = 0.3, alpha = 1) +\n        geom_beeswarm(aes(group = Type2), dodge.width = 0.8, shape = 21, size = 2.5, colour = \"black\", cex = 2) +\n        labs(fill = input$col_factor2) +\n        geom_pwc(aes(group = Type2), method = \"t_test\", label = \"p.signif\", hide.ns = \"p\")\n    } else {\n      p <- p + aes(fill = Type1) +\n        stat_summary(fun = mean, geom = \"bar\", width = 0.8, color = \"black\") +\n        stat_summary(fun.data = mean_sdl, fun.args = list(mult = 1), geom = \"errorbar\", width = 0.3, alpha = 1) +\n        geom_beeswarm(shape = 21, size = 2.5, colour = \"black\", cex = 2) +\n        theme(legend.position = \"none\") +\n        geom_pwc(method = \"t_test\", label = \"p.signif\", hide.ns = \"p\")\n    }\n    \n    p <- p +\n      labs(title = \"Doubling Time Analysis\", x = input$col_factor1, y = \"Doubling Time (hours)\") +\n      scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +\n      theme_classic(base_size = 16) +\n      theme(axis.text = element_text(color = \"black\"), axis.line = element_line(linewidth = 0.8), legend.title = element_text(face = \"bold\"),\n            strip.background = element_rect(fill=\"grey95\"))\n    return(p)\n  })\n  \n  # --- 3. Outputs & Downloads ---\n  output$raw_table <- renderDT({ req(raw_data()); datatable(raw_data(), options = list(scrollX = TRUE)) })\n  output$plot_gc <- renderPlot({ gc_plot_obj() })\n  output$plot_dt <- renderPlot({ dt_plot_obj() })\n  \n  dt_summary <- reactive({\n    req(dt_data())\n    grp_vars <- c(\"Type1\")\n    if(input$col_factor2 != \"None\") grp_vars <- c(grp_vars, \"Type2\")\n    if(input$col_factor3 != \"None\") grp_vars <- c(grp_vars, \"Type3\")\n    dt_data() %>% group_by(across(all_of(grp_vars))) %>%\n      summarise(Mean_DT = round(mean(doubling_time_hours), 2), SD = round(sd(doubling_time_hours), 2), N = n(), .groups = \"drop\")\n  })\n  \n  output$dt_table <- renderDT({\n    req(dt_summary())\n    datatable(dt_summary(), extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('copy', 'csv', 'excel')))\n  })\n  \n  output$dl_gc_png <- downloadHandler(\n    filename = function() { paste(\"GrowthCurve_\", Sys.Date(), \".png\", sep=\"\") },\n    content = function(file) { ggsave(file, plot = gc_plot_obj(), device = \"png\", dpi = 300, width = 8, height = 6) }\n  )\n  output$dl_gc_svg <- downloadHandler(\n    filename = function() { paste(\"GrowthCurve_\", Sys.Date(), \".svg\", sep=\"\") },\n    content = function(file) { ggsave(file, plot = gc_plot_obj(), device = \"svg\", width = 8, height = 6) }\n  )\n  output$dl_dt_png <- downloadHandler(\n    filename = function() { paste(\"DoublingTime_\", Sys.Date(), \".png\", sep=\"\") },\n    content = function(file) { ggsave(file, plot = dt_plot_obj(), device = \"png\", dpi = 300, width = 8, height = 6) }\n  )\n  output$dl_dt_svg <- downloadHandler(\n    filename = function() { paste(\"DoublingTime_\", Sys.Date(), \".svg\", sep=\"\") },\n    content = function(file) { ggsave(file, plot = dt_plot_obj(), device = \"svg\", width = 8, height = 6) }\n  )\n}\n\nshinyApp(ui = ui, server = server)","type":"text"}]
